<!--
  Copyright 2025 FBK

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üéôÔ∏è FBK Simultaneous Translation Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, rgb(9,73,154), #3b82f6);
      color: #333;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    
    .logo {
      position: absolute;
      top: 3em;
      right: 3em;
      width: auto;
      height: 6em;
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .container {
      background: rgba(255, 255, 255, 0.6);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.2);
      text-align: center;
      backdrop-filter: blur(12px);
      animation: fadeIn 1s ease-in-out;
      width: 90%;
      max-width: 600px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 20px;
      color: #222;
    }

    canvas {
      width: 100%;
      height: 100px;
      background: #ffffff;
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .controls {
      margin: 20px 0;
    }

    button {
      padding: 12px 24px;
      margin: 0 10px;
      border: none;
      border-radius: 30px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    #startBtn {
      background: linear-gradient(to right, #10b981, #34d399);
      color: white;
    }

    #startBtn:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }

    #stopBtn {
      background: linear-gradient(to right, #ef4444, #f87171);
      color: white;
    }

    #stopBtn:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
    }

    #status {
      font-size: 1rem;
      margin-top: 10px;
      color: #444;
    }

    .pulse {
      display: inline-block;
      width: 10px;
      height: 10px;
      margin-right: 8px;
      background-color: #10b981;
      border-radius: 50%;
      animation: pulse 1s infinite;
      vertical-align: middle;
    }

    .pulse.red {
      background-color: #ef4444;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.5);
        opacity: 0.5;
      }
    }
    
    .footer {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: #555;
      background: rgba(255, 255, 255, 0.5);
      padding: 6px 12px;
      border-radius: 12px;
      backdrop-filter: blur(5px);
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .footer-logo {
      height: 4em;
      width: auto;
    }

    .language-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      font-size: 1rem;
      color: #333;
    }

    .language-selector select {
      padding: 6px 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      transition: border 0.2s;
    }

    .language-selector select:hover {
      border-color: #0078D7;
    }

    #transcript-box {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9fc;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      height: 8em;
      overflow-y: auto;
      font-family: "Segoe UI", sans-serif;
      font-size: 1rem;
      color: #333;
      line-height: 1.4;
      transition: all 0.3s ease;
    }

    #transcript-box h3 {
      margin: 0 0 10px 0;
      font-size: 1.1rem;
      color: #444;
    }

    #transcript-text {
      white-space: pre-wrap;
    }

  </style>
</head>
<body>

  <div class="logo">
    <img src="FBK_white_transp.png" alt="Logo">
  </div>

  <div class="container">
    <h1>üéôÔ∏è FBK SimulST Demo</h1>
    <canvas id="visualizer"></canvas>
    <div class="language-selector">
      <label for="language">Output Language:</label>
      <select id="language">
      </select>
    </div>
    <div class="controls">
      <button id="startBtn">Start Recording</button>
      <button id="stopBtn" disabled>Stop Recording</button>
    </div>
    <p id="status"><span class="pulse red"></span>Status: Idle</p>
    <div id="transcript-box">
      <h3>Output</h3>
      <div id="transcript-text"></div>
    </div>
  </div>

  <div id="credits" class="footer">
    <span>Powered by <strong id="credits_model_name"></strong></span>
  </div>

  <script>
    async function loadConfig(url) {
      try {
        const response = await fetch(url);

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const yamlText = await response.text();
        const data = jsyaml.load(yamlText);

        console.log("Parsed YAML:", data);
        return data;
      } catch (error) {
        console.error("Error loading YAML:", error);
      }
    }

    // Example usage
    const configLoader = loadConfig('../config/server.yaml');

    let stream;
    let socket;
    let processorNode;
    let audioContext;
    let analyser;
    let dataArray;
    let source;
    let animationId;

    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusText = document.getElementById('status');

    configLoader.then(function (config) {
      if (config.supported_langs) {
        const langSelect = document.getElementById('language');
        for (var i = 0; i < config.supported_langs.length; ++i) {
          Object.entries(config.supported_langs[i]).forEach(([langId, langText]) => {
            const langOpt = document.createElement('option');
            langOpt.value = langId;
            langOpt.text = langText;
            langSelect.append(langOpt);
          });
        }
      }
      const credits = document.getElementById('credits');
      if (config.model_name) {
        document.getElementById('credits_model_name').textContent = config.model_name;
        if (config.model_logo) {
          const logoImg = document.createElement('img');
          logoImg.src = config.model_logo;
          logoImg.className = 'footer-logo';
          logoImg.alt = config.model_name + ' logo';
          credits.prepend(logoImg);
        }
      }
    });

    function updateStatus(text, color = 'red') {
      statusText.textContent = '';
      const pulse = document.createElement('span');
      pulse.className = `pulse ${color}`;
      statusText.appendChild(pulse);
      statusText.append(` ${text}`);
    }

    function drawVisualizer() {
      if (!analyser) return;
      animationId = requestAnimationFrame(drawVisualizer);

      analyser.getByteTimeDomainData(dataArray);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#3b82f6';
      ctx.beginPath();

      const sliceWidth = canvas.width / dataArray.length;
      let x = 0;

      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * canvas.height / 2;

        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);

        x += sliceWidth;
      }

      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();
    }

    function float32ToInt16(float32) {
      const int16 = new Int16Array(float32.length);
      for (let i = 0; i < float32.length; i++) {
        let s = float32[i] * 32768;
        int16[i] = Math.max(-32768, Math.min(32767, s));
      }
      return int16;
    }

    function resampleTo16kHz(input, fromRate) {
      const ratio = fromRate / 16000;
      const length = Math.floor(input.length / ratio);
      const output = new Float32Array(length);
      for (let i = 0; i < length; i++) {
        output[i] = input[Math.floor(i * ratio)];
      }
      return output;
    }

    startBtn.addEventListener('click', async () => {
      if (!navigator.mediaDevices) {
        alert("Your browser doesn't support audio recording.");
        return;
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const inputSampleRate = audioContext.sampleRate;
        // Visualizer Setup
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);
        drawVisualizer();

        // WebSocket Setup
        const websocker_url = await configLoader.then(function (config) {
          const secure = config.secure ? 's' : '';
          return 'ws' + secure + '://' + config.hostname + ':' + config.port;
        });
        socket = new WebSocket(websocker_url);

        socket.onopen = () => {
          updateStatus("Connected & Recording...", 'green');
          let lang = document.getElementById("language").value;
          socket.send(JSON.stringify({ target_lang: lang, sample_rate: inputSampleRate}));
        };

        socket.onerror = () => {
          updateStatus("WebSocket error.", 'red');
        };

        socket.onmessage = (event) => {
          const transcription = JSON.parse(event.data);
          const transcriptText = document.getElementById('transcript-text');
          const charToDelete = transcription.deleted.length;
          const newTranscriptLen = transcriptText.textContent.length - charToDelete;
          transcriptText.textContent = transcriptText.textContent.substring(0, newTranscriptLen);
          transcriptText.textContent += transcription.new;

          // Auto-scroll to bottom
          const container = document.getElementById('transcript-box');
          container.scrollTop = container.scrollHeight;
        };

        await audioContext.audioWorklet.addModule('processor.js');

        processorNode = new AudioWorkletNode(audioContext, 'pcm-processor');
        source.connect(processorNode).connect(audioContext.destination);

        processorNode.port.onmessage = (event) => {
          if (event.data.length > 0 && socket.readyState === WebSocket.OPEN) {
            const float32 = event.data;
            // const resampled = resampleTo16kHz(float32, inputSampleRate);
            // Convert Float32Array to Int16Array for compactness
            // const int16 = float32ToInt16(resampled);
            const int16 = float32ToInt16(float32);
            socket.send(int16.buffer);
          }
        };

        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        console.error("Error:", err);
        updateStatus("Error accessing microphone.", 'red');
      }
    });

    stopBtn.addEventListener('click', () => {
      if (processorNode) processorNode.disconnect();
      if (audioContext) audioContext.close();
      if (socket) socket.close();
      if (stream) stream.getTracks().forEach(track => track.stop());
      updateStatus("Stopped and connection closed.", 'red');
      cancelAnimationFrame(animationId);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      startBtn.disabled = false;
      stopBtn.disabled = true;
    });

    // Resize canvas to match display size
    function resizeCanvas() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
  </script>
</body>
</html>

